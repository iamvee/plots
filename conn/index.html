<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #f8fafc; }
        #chart-container { position: relative; width: 100%; min-height: 70vh; }
        svg { width: 100%; height: auto; max-width: 900px; font: 10px sans-serif; }
        path.link { fill: none; stroke-opacity: 0.3; }
        .node { cursor: pointer; }
        .node:hover > text { font-weight: bold; fill: #ee9b00; }
        .node--leaf text { fill: #005f73; font-size: 10px; }
        .node--internal text { fill: #ca6702; font-size: 12px; font-weight: 700; text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, 0 -1px 0 #fff, -1px 0 0 #fff; }
        .theme-arc { fill: none; stroke-width: 4; opacity: 0.7; cursor: pointer; }
        #tooltip { position: absolute; background-color: white; border: 1px solid #ccc; border-radius: 8px; padding: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); pointer-events: none; opacity: 0; transition: opacity 0.2s; max-width: 300px; font-size: 12px; z-index: 1000; }
        #tooltip h3 { font-size: 14px; font-weight: bold; margin-bottom: 4px; color: #005f73; }
        .json-input { font-family: 'Courier New', monospace; font-size: 12px; }
        .error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .success { border-color: #22c55e !important; background-color: #f0fdf4 !important; }
        .status-message { font-size: 12px; margin-top: 4px; }
        .error-message { color: #ef4444; }
        .success-message { color: #22c55e; }

        /* New Legend Styles */
        .legend-container {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
            width: 220px;
            z-index: 50;
        }
        .legend-header {
            padding: 8px 12px;
            font-weight: 600;
            background-color: #f1f5f9;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 1px solid #e2e8f0;
            cursor: move;
        }
        .legend-content {
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
            border-radius: 4px;
            padding: 2px 4px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: #e2e8f0;
        }
        .legend-item.highlighted {
            background-color: #e2e8f0;
            font-weight: bold;
        }
        .legend-rect {
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border: 1px solid #64748b;
        }
        .legend-text { font-size: 12px; color: #334155; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#003f5c]">Interactive Research Connections Visualizer</h1>
            <p class="mt-2 text-gray-600">Visualize relationships between research papers based on shared themes.</p>
        </header>

        <div id="chart-container" class="bg-white rounded-lg shadow-md mb-8 border border-gray-200">
            <div id="placeholder" class="flex items-center justify-center h-full text-center text-gray-500 py-16">
                <p class="text-lg">Enter your data below and click "Generate Visualization" to see the chart.</p>
            </div>
            <svg id="chart" style="display: none;"></svg>
        </div>

        <div id="controls-panel" class="bg-white p-6 rounded-lg shadow-md mb-8" style="display:none;">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">Display Controls</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="paperFontSize" class="block text-sm font-medium text-gray-700">Paper Font Size</label>
                    <input type="range" id="paperFontSize" min="5" max="15" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="themeFontSize" class="block text-sm font-medium text-gray-700">Theme Font Size</label>
                    <input type="range" id="themeFontSize" min="8" max="20" value="12" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="linkOpacity" class="block text-sm font-medium text-gray-700">Link Opacity</label>
                    <input type="range" id="linkOpacity" min="0" max="1" step="0.1" value="0.3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div>
                    <label for="citationScale" class="block text-sm font-medium text-gray-700">Citation Sizing</label>
                    <input type="range" id="citationScale" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Paper Data (JSON)</h3>
                <textarea id="paperDataInput" class="json-input w-full h-64 p-3 border border-gray-300 rounded-md resize-none" placeholder='[{"author": "Smith (2023)", "year": 2023, "title": "Example", "themes": ["A", "B"], "citations": 10}]'></textarea>
                <div id="paperDataStatus" class="status-message"></div>
                <div class="mt-2 text-xs text-gray-500">Required: author, year, title, themes (array), citations.</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Theme Mapping (JSON)</h3>
                <textarea id="themeMapInput" class="json-input w-full h-64 p-3 border border-gray-300 rounded-md resize-none" placeholder='{"A": "Machine Learning", "B": "Data Analysis"}'></textarea>
                <div id="themeMapStatus" class="status-message"></div>
                <div class="mt-2 text-xs text-gray-500">Format: Object mapping theme keys to descriptive names.</div>
            </div>
        </div>

        <div class="text-center mb-6">
            <button id="generateBtn" class="bg-[#005f73] hover:bg-[#0a7a8a] text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200" disabled>Generate Visualization</button>
            <button id="loadExampleBtn" class="ml-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-200">Load Example Data</button>
        </div>

        <div id="tooltip"></div>
    </div>

<script>
const examplePaperData = [{"author": "#1", "year": 2025, "title": "Title #1", "themes": ["E", "C", "D"], "citations": 0},{"author": "#2", "year": 2025, "title": "Title #2", "themes": ["E", "D", "G"], "citations": 0},{"author": "#3", "year": 2025, "title": "Title #3", "themes": ["C", "E"], "citations": 0},{"author": "#4", "year": 2025, "title": "Title #4", "themes": ["E", "F"], "citations": 0},{"author": "#5", "year": 2025, "title": "Title #5", "themes": ["D", "G"], "citations": 0},{"author": "#6", "year": 2024, "title": "Title #6", "themes": ["B", "D", "G"], "citations": 0},{"author": "#7", "year": 2024, "title": "Title #7", "themes": ["A", "B", "C"], "citations": 1},{"author": "#8", "year": 2024, "title": "Title #8", "themes": ["B", "G"], "citations": 0},{"author": "#9", "year": 2024, "title": "Title #9", "themes": ["D", "B"], "citations": 0},{"author": "#10", "year": 2023, "title": "Title #10", "themes": ["A", "B", "C"], "citations": 15},{"author": "#11", "year": 2023, "title": "Title #11", "themes": ["A", "B", "F"], "citations": 11},{"author": "#12", "year": 2023, "title": "Title #12", "themes": ["B", "D", "F"], "citations": 22},{"author": "#13", "year": 2023, "title": "Title #13", "themes": ["E", "F"], "citations": 23},{"author": "#14", "year": 2023, "title": "Title #14", "themes": ["C", "E"], "citations": 11},{"author": "#15", "year": 2023, "title": "Title #15", "themes": ["D"], "citations": 14},{"author": "#16", "year": 2022, "title": "Title #16", "themes": ["C", "E"], "citations": 45},{"author": "#17", "year": 2022, "title": "Title #17", "themes": ["A", "B"], "citations": 49},{"author": "#18", "year": 2022, "title": "Title #18", "themes": ["B", "G"], "citations": 11},{"author": "#19", "year": 2022, "title": "Title #19", "themes": ["D", "B", "F"], "citations": 18},{"author": "#20", "year": 2022, "title": "Title #20", "themes": ["C"], "citations": 16},{"author": "#21", "year": 2022, "title": "Title #21", "themes": ["B", "C"], "citations": 27},{"author": "#22", "year": 2021, "title": "Title #22", "themes": ["A", "B", "G"], "citations": 5},{"author": "#23", "year": 2021, "title": "Title #23", "themes": ["C", "D", "F"], "citations": 35},{"author": "#24", "year": 2021, "title": "Title #24", "themes": ["B", "G"], "citations": 22},{"author": "#25", "year": 2021, "title": "Title #25", "themes": ["B", "E"], "citations": 43},{"author": "#26", "year": 2021, "title": "Title #26", "themes": ["E", "F"], "citations": 72},{"author": "#27", "year": 2021, "title": "Title #27", "themes": ["A", "B", "C", "D", "E", "F", "G"], "citations": 258},{"author": "#28", "year": 2021, "title": "Title #28", "themes": ["B", "D"], "citations": 49},{"author": "#29", "year": 2021, "title": "Title #29", "themes": ["B", "F"], "citations": 27},{"author": "#30", "year": 2020, "title": "Title #30", "themes": ["B"], "citations": 14},{"author": "#31", "year": 2020, "title": "Title #31", "themes": ["C", "E", "F"], "citations": 27},{"author": "#32", "year": 2020, "title": "Title #32", "themes": ["E", "C"], "citations": 54},{"author": "#33", "year": 2020, "title": "Title #33", "themes": ["A", "B", "G"], "citations": 114},{"author": "#34", "year": 2020, "title": "Title #34", "themes": ["D", "B"], "citations": 45},{"author": "#35", "year": 2020, "title": "Title #35", "themes": ["D", "B", "G"], "citations": 202},{"author": "#36", "year": 2020, "title": "Title #36", "themes": ["C", "E"], "citations": 48},{"author": "#37", "year": 2020, "title": "Title #37", "themes": ["C"], "citations": 41},{"author": "#38", "year": 2020, "title": "Title #38", "themes": ["E", "D"], "citations": 15},{"author": "#39", "year": 2019, "title": "Title #39", "themes": ["D", "B"], "citations": 103},{"author": "#40", "year": 2019, "title": "Title #40", "themes": ["A", "B", "C", "E", "F", "G"], "citations": 439},{"author": "#41", "year": 2019, "title": "Title #41", "themes": ["A", "B"], "citations": 134},{"author": "#42", "year": 2019, "title": "Title #42", "themes": ["C", "A"], "citations": 31},{"author": "#43", "year": 2019, "title": "Title #43", "themes": ["B"], "citations": 19},{"author": "#44", "year": 2019, "title": "Title #44", "themes": ["C"], "citations": 47},{"author": "#45", "year": 2018, "title": "Title #45", "themes": ["B", "D"], "citations": 280},{"author": "#46", "year": 2018, "title": "Title #46", "themes": ["B"], "citations": 30},{"author": "#47", "year": 2018, "title": "Title #47", "themes": ["C", "E"], "citations": 48},{"author": "#48", "year": 2017, "title": "Title #48", "themes": ["B", "C"], "citations": 80},{"author": "#49", "year": 2017, "title": "Title #49", "themes": ["B", "E", "F"], "citations": 49},{"author": "#50", "year": 2016, "title": "Title #50", "themes": ["G", "B"], "citations": 148},{"author": "#51", "year": 2016, "title": "Title #51", "themes": ["D", "B"], "citations": 455},{"author": "#52", "year": 2016, "title": "Title #52", "themes": ["B", "D"], "citations": 311},{"author": "#53", "year": 2016, "title": "Title #53", "themes": ["D"], "citations": 205},{"author": "#54", "year": 2015, "title": "Title #54", "themes": ["D", "E", "F"], "citations": 79},{"author": "#55", "year": 2015, "title": "Title #55", "themes": ["B", "D"], "citations": 98}];
const exampleThemeMap = { "A": "Physics-Informed ML", "B": "Personalized EP Calibration", "C": "Surrogate/ROM Acceleration", "D": "Arrhythmia Prediction", "E": "EM Coupling via ML", "F": "Multi-scale EP Modeling", "G": "Uncertainty & Interpretability"};

// Global variables
let currentPaperData = [];
let currentThemeMap = {};
let themeColors = {};

function generateColors(themes) {
    const colors = {};
    const hueStep = 360 / Object.keys(themes).length;
    let hue = 0;
    Object.keys(themes).forEach(key => {
        colors[key] = d3.hsl(hue, 0.7, 0.5).toString();
        hue += hueStep;
    });
    return colors;
}

function validateJSON(text, type) {
    try {
        const parsed = JSON.parse(text);
        if (type === 'paperData') {
            if (!Array.isArray(parsed)) throw new Error('Paper data must be an array');
            parsed.forEach((paper, index) => {
                if (!paper.author || !paper.title || !paper.themes || !Array.isArray(paper.themes) || paper.citations === undefined) {
                    throw new Error(`Paper at index ${index} is missing required fields`);
                }
            });
        } else if (type === 'themeMap') {
            if (typeof parsed !== 'object' || Array.isArray(parsed)) throw new Error('Theme map must be an object');
        }
        return { valid: true, data: parsed };
    } catch (error) {
        return { valid: false, error: error.message };
    }
}

function updateValidationStatus(inputId, statusId, validation) {
    const input = document.getElementById(inputId);
    const status = document.getElementById(statusId);
    if (validation.valid) {
        input.classList.remove('error');
        input.classList.add('success');
        status.textContent = '✓ Valid JSON';
        status.className = 'status-message success-message';
    } else {
        input.classList.remove('success');
        input.classList.add('error');
        status.textContent = '✗ ' + validation.error;
        status.className = 'status-message error-message';
    }
    updateGenerateButton();
}

function updateGenerateButton() {
    const paperData = document.getElementById('paperDataInput').value.trim();
    const themeMap = document.getElementById('themeMapInput').value.trim();
    const generateBtn = document.getElementById('generateBtn');
    const paperValid = paperData && validateJSON(paperData, 'paperData').valid;
    const themeValid = themeMap && validateJSON(themeMap, 'themeMap').valid;
    generateBtn.disabled = !(paperValid && themeValid);
}

document.getElementById('paperDataInput').addEventListener('input', function() {
    const validation = validateJSON(this.value, 'paperData');
    updateValidationStatus('paperDataInput', 'paperDataStatus', validation);
});

document.getElementById('themeMapInput').addEventListener('input', function() {
    const validation = validateJSON(this.value, 'themeMap');
    updateValidationStatus('themeMapInput', 'themeMapStatus', validation);
});

document.getElementById('loadExampleBtn').addEventListener('click', function() {
    document.getElementById('paperDataInput').value = JSON.stringify(examplePaperData, null, 2);
    document.getElementById('themeMapInput').value = JSON.stringify(exampleThemeMap, null, 2);
    document.getElementById('paperDataInput').dispatchEvent(new Event('input'));
    document.getElementById('themeMapInput').dispatchEvent(new Event('input'));
});

document.getElementById('generateBtn').addEventListener('click', function() {
    const paperDataText = document.getElementById('paperDataInput').value;
    const themeMapText = document.getElementById('themeMapInput').value;
    currentPaperData = JSON.parse(paperDataText).map((d, i) => ({...d, id: i}));
    currentThemeMap = JSON.parse(themeMapText);
    themeColors = generateColors(currentThemeMap);
    generateVisualization();
});


function buildHierarchy(data, themeMap) {
    const hierarchy = { name: "root", children: [] };
    const themes = {};
    Object.entries(themeMap).forEach(([key, value]) => {
        themes[key] = { name: value, children: [] };
        hierarchy.children.push(themes[key]);
    });
    data.forEach(paper => {
        paper.themes.forEach(themeKey => {
            if (themes[themeKey]) {
                themes[themeKey].children.push({ name: `${paper.author}`, paperId: paper.id, title: paper.title, themes: paper.themes, year: paper.year, citations: paper.citations });
            }
        });
    });
    return hierarchy;
}

function generateVisualization() {
    d3.select("#chart").selectAll("*").remove();
    d3.select("#chart-container").selectAll(".legend-container").remove();
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('chart').style.display = 'block';
    document.getElementById('controls-panel').style.display = 'block';

    const data = buildHierarchy(currentPaperData, currentThemeMap);
    const width = 900;
    const radius = width / 2;
    const tree = d3.cluster().size([2 * Math.PI, radius - 150]);
    const root = tree(d3.hierarchy(data).sort((a, b) => d3.ascending(a.data.name, b.data.name)));
    const svg = d3.select("#chart").attr("viewBox", [-radius, -radius, width, width]);
    const tooltip = d3.select("#tooltip");

    const links = [];
    const paperNodes = root.leaves();
    const paperMap = new Map();
    paperNodes.forEach(leaf => {
        if (!paperMap.has(leaf.data.paperId)) paperMap.set(leaf.data.paperId, []);
        paperMap.get(leaf.data.paperId).push(leaf);
    });
    for (const nodes of paperMap.values()) {
        if (nodes.length > 1) {
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) links.push({ source: nodes[i], target: nodes[j] });
            }
        }
    }

    const line = d3.lineRadial().curve(d3.curveBundle.beta(0.85)).radius(d => d.y).angle(d => d.x);

    const link = svg.append("g")
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("class", "link")
        .attr("d", d => line(d.source.path(d.target)))
        .style("stroke", d => {
            const themeName = d.source.parent.data.name;
            const themeKey = Object.keys(currentThemeMap).find(key => currentThemeMap[key] === themeName);
            return themeColors[themeKey] || '#ccc';
        })
        .each(function(d) { d.path = this; });

    const themeNodes = root.descendants().filter(d => d.depth === 1);
    const arcRadius = radius - 100;
    themeNodes.forEach((themeNode) => {
        const themeKey = Object.keys(currentThemeMap).find(key => currentThemeMap[key] === themeNode.data.name);
        const color = themeColors[themeKey] || '#ca6702';
        const themeLeaves = themeNode.leaves();
        if (themeLeaves.length === 0) return;
        const angles = themeLeaves.map(d => d.x);
        const padding = 0.05;
        const startAngle = Math.min(...angles) - padding;
        const endAngle = Math.max(...angles) + padding;
        const arc = d3.arc().innerRadius(arcRadius).outerRadius(arcRadius).startAngle(startAngle).endAngle(endAngle);

        svg.append("path")
            .datum({themeKey: themeKey, themeNode: themeNode})
            .attr("class", "theme-arc")
            .attr("d", arc())
            .style("stroke", color)
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);
    });
    
    // Create Legend using HTML for better control
    createDraggableLegend();

    const node = svg.append("g")
        .selectAll("g")
        .data(root.leaves())
        .join("g")
        .attr("class", "node node--leaf")
        .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y},0)`)
        .on("mouseover", mouseovered)
        .on("mouseout", mouseouted)
        .on("mousemove", (event) => {
            tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
        });

    node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.x < Math.PI ? 6 : -6)
        .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
        .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
        .text(d => d.data.name)
        .clone(true).lower().attr("stroke", "white");
        
    // Add internal theme nodes text
    svg.append("g")
      .selectAll("g")
      .data(root.descendants().filter(d => d.depth === 1))
      .join("g")
      .attr("class", "node node--internal")
      .attr("transform", d => `rotate(${d.x * 180 / Math.PI - 90}) translate(${d.y - 20},0)`)
      .append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.x < Math.PI ? 6 : -6)
        .attr("text-anchor", d => d.x < Math.PI ? "start" : "end")
        .attr("transform", d => d.x >= Math.PI ? "rotate(180)" : null)
        .text(d => d.data.name);

    function mouseovered(event, d) {
        tooltip.transition().duration(200).style("opacity", .95);
        tooltip.html(`<h3>${d.data.title}</h3><p><strong>Author:</strong> ${d.data.name}</p><p><strong>Year:</strong> ${d.data.year}</p><p><strong>Citations:</strong> ${d.data.citations}</p><p><strong>Themes:</strong> ${d.data.themes.map(t => currentThemeMap[t] || t).join(', ')}</p>`);
        d3.select(this).select("text").style("font-weight", "bold");
        const connectedLinks = links.filter(l => l.source.data.paperId === d.data.paperId || l.target.data.paperId === d.data.paperId);
        d3.selectAll(".link").style("stroke-opacity", 0.05);
        connectedLinks.forEach(l => d3.select(l.path).style("stroke", "#ee9b00").style("stroke-opacity", 0.8).style("stroke-width", "2px").raise());
    }

    function mouseouted() {
        tooltip.transition().duration(500).style("opacity", 0);
        d3.selectAll(".link")
            .style("stroke-opacity", document.getElementById('linkOpacity').value)
            .style("stroke-width", "1px")
            .style("stroke", d => {
                const themeName = d.source.parent.data.name;
                const themeKey = Object.keys(currentThemeMap).find(key => currentThemeMap[key] === themeName);
                return themeColors[themeKey] || '#ccc';
            });
        d3.selectAll(".node--leaf text").style("font-weight", null);
    }
    
    // Initial setup of controls
    setupControls();
}

function createDraggableLegend() {
    const legendData = Object.entries(currentThemeMap).map(([key, value]) => ({ key: key, name: value, color: themeColors[key] }));

    const legendContainer = d3.select("#chart-container")
        .append("div")
        .attr("class", "legend-container")
        .style("top", "20px")
        .style("right", "20px");

    const legendHeader = legendContainer.append("div")
        .attr("class", "legend-header")
        .text("Themes");
    
    const legendContent = legendContainer.append("div")
        .attr("class", "legend-content");

    const legendItems = legendContent.selectAll(".legend-item")
        .data(legendData)
        .enter()
        .append("div")
        .attr("class", "legend-item")
        .on("mouseover", (event, d) => handleMouseOver(event, { themeKey: d.key, themeNode: findThemeNode(d.key) }))
        .on("mouseout", (event, d) => handleMouseOut(event, { themeKey: d.key, color: d.color }));

    legendItems.append("div")
        .attr("class", "legend-rect")
        .style("background-color", d => d.color);

    legendItems.append("span")
        .attr("class", "legend-text")
        .text(d => d.name);
    
    // Drag functionality
    let offsetX, offsetY;
    const drag = d3.drag()
        .on("start", function(event) {
            const rect = legendContainer.node().getBoundingClientRect();
            offsetX = event.sourceEvent.clientX - rect.left;
            offsetY = event.sourceEvent.clientY - rect.top;
            d3.select(this).style("cursor", "grabbing");
        })
        .on("drag", function(event) {
            const containerRect = d3.select("#chart-container").node().getBoundingClientRect();
            legendContainer
                .style("left", (event.sourceEvent.clientX - containerRect.left - offsetX) + "px")
                .style("top", (event.sourceEvent.clientY - containerRect.top - offsetY) + "px")
                .style("right", null); // remove right positioning
        })
        .on("end", function() {
            d3.select(this).style("cursor", "move");
        });
    
    legendHeader.call(drag);
}


function findThemeNode(themeKey) {
    const root = d3.select('#chart').datum(); // This is a trick to get the root data back
    if (!root) return null;
    return root.descendants().find(node => {
        const key = Object.keys(currentThemeMap).find(k => currentThemeMap[k] === node.data.name);
        return key === themeKey;
    });
}


function handleMouseOver(event, d) {
    const themeKey = d.themeKey;
    const themeNode = d.themeNode || findThemeNode(themeKey);

    // Highlight arc
    d3.selectAll(".theme-arc").filter(arcData => arcData.themeKey === themeKey)
      .style("stroke", "#ee9b00").style("stroke-width", "6px");
    
    // Highlight legend item
    d3.selectAll(".legend-item").filter(legendData => legendData.key === themeKey)
      .classed("highlighted", true);

    if (themeNode) {
        const themePapers = themeNode.leaves().map(leaf => leaf.data.paperId);
        d3.selectAll(".node--leaf").filter(leaf => themePapers.includes(leaf.data.paperId))
          .select("text").style("font-weight", "bold").style("fill", "#ee9b00");

        d3.selectAll(".link").style("stroke-opacity", 0.05);
        d3.selectAll(".link").filter(l => {
            const sourcePaper = currentPaperData.find(p => p.id === l.source.data.paperId);
            const targetPaper = currentPaperData.find(p => p.id === l.target.data.paperId);
            return sourcePaper && targetPaper && sourcePaper.themes.includes(themeKey) && targetPaper.themes.includes(themeKey);
        }).each(function(l) {
            d3.select(l.path).style("stroke", "#ee9b00").style("stroke-opacity", 0.8).style("stroke-width", "2px").raise();
        });
    }
}

function handleMouseOut(event, d) {
    const themeKey = d.themeKey;
    const color = d.color || themeColors[themeKey];

    // Reset arc
    d3.selectAll(".theme-arc").filter(arcData => arcData.themeKey === themeKey)
      .style("stroke", color).style("stroke-width", "4px");
    
    // Reset legend item
     d3.selectAll(".legend-item").filter(legendData => legendData.key === themeKey)
      .classed("highlighted", false);

    // Reset all nodes and links
    d3.selectAll(".node--leaf text").style("font-weight", null).style("fill", "#005f73");
    d3.selectAll(".link")
      .style("stroke-opacity", document.getElementById('linkOpacity').value)
      .style("stroke-width", "1px")
      .style("stroke", d => {
          const themeName = d.source.parent.data.name;
          const key = Object.keys(currentThemeMap).find(k => currentThemeMap[k] === themeName);
          return themeColors[key] || '#ccc';
      });
}

function setupControls() {
    d3.select("#paperFontSize").on("input", function() {
        d3.selectAll(".node--leaf text").style("font-size", this.value + "px");
    });
    d3.select("#themeFontSize").on("input", function() {
        d3.selectAll(".node--internal text").style("font-size", this.value + "px");
    });
    d3.select("#linkOpacity").on("input", function() {
        d3.selectAll(".link").style("stroke-opacity", this.value);
    });
    d3.select("#citationScale").on("input", function() {
        updateCitationSizing(this.value);
    });
    
    // Apply initial values
    updateCitationSizing(document.getElementById('citationScale').value);
    d3.selectAll(".node--leaf text").style("font-size", document.getElementById('paperFontSize').value + "px");
    d3.selectAll(".node--internal text").style("font-size", document.getElementById('themeFontSize').value + "px");
    d3.selectAll(".link").style("stroke-opacity", document.getElementById('linkOpacity').value);
}

function updateCitationSizing(scaleValue) {
    const maxCitations = d3.max(currentPaperData, d => d.citations);
    if (maxCitations === 0) return;
    
    const scale = scaleValue / 100; // Normalize slider value
    
    d3.selectAll(".node--leaf").select("text")
        .style("font-weight", d => {
            const weight = 400 + (d.data.citations / maxCitations) * 400 * scale;
            return Math.min(800, weight); // Cap at 800
        });
}


updateGenerateButton();
</script>
</body>
</html>