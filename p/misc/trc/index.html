<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRC File Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .sticky-header th {
            position: sticky;
            z-index: 10;
            background-color: #f9fafb;
        }
        .sticky-header .top-header-row th {
            top: 0;
        }
        .sticky-header .bottom-header-row th {
            top: 45px;
        }

        .table-container.scrolling .sticky-header th {
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">TRC to XLSX (merge multiple files)</h1>
            <p class="text-lg text-gray-600 mt-2">Drag and drop one or more .trc files to begin.</p>
        </header>
        <div id="drop-zone" class="mb-8 p-10 border-4 border-dashed border-gray-300 rounded-2xl bg-white text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-50">
            <div id="drop-zone-content">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="mt-5 text-xl text-gray-600">
                    <span class="font-semibold text-blue-600">Upload files</span> or drag and drop
                </p>
                <p class="mt-1 text-sm text-gray-500">TRC files only</p>
                <input type="file" id="file-input" class="hidden" accept=".trc" multiple>
            </div>
            <div id="loading-spinner" class="hidden">
                 <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    <p class="ml-4 text-lg text-gray-700">Parsing files...</p>
                 </div>
            </div>
        </div>
        <div id="data-display" class="hidden">
            <div class="bg-white p-6 rounded-2xl shadow-md mb-8">
                 <div class="flex flex-wrap justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold mb-2 md:mb-0">Analysis Toolkit</h2>
                    <button id="download-btn" disabled class="px-5 py-2.5 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all">
                        Download All as Excel (.xlsx)
                    </button>
                 </div>
                 <div class="relative">
                    <input type="text" id="search-input" placeholder="Search data in the active table..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                     <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                 </div>
                 <p class="text-sm text-gray-500 mt-2">Showing <span id="row-count">0</span> rows in active table.</p>
            </div>
            <div class="mb-4">
                <div id="tabs-container" class="flex flex-wrap items-center gap-2 border-b border-gray-200"></div>
            </div>
            <div id="metadata-container" class="bg-white p-6 rounded-2xl shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">File Metadata</h2>
                <div id="metadata-content" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm"></div>
            </div>
            <div class="bg-white rounded-2xl shadow-md overflow-hidden">
                <div id="table-container" class="overflow-auto max-h-[70vh] table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="table-head" class="bg-gray-50 sticky-header"></thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="error-message" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const dropZoneContent = document.getElementById('drop-zone-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const dataDisplay = document.getElementById('data-display');
        const metadataContent = document.getElementById('metadata-content');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const searchInput = document.getElementById('search-input');
        const rowCount = document.getElementById('row-count');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const tableContainer = document.getElementById('table-container');
        const downloadBtn = document.getElementById('download-btn');
        const tabsContainer = document.getElementById('tabs-container');

        let processedFiles = [];
        let activeFileIndex = 0;

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(e.target.files);
            }
        });

        searchInput.addEventListener('input', (e) => {
            filterAndRenderTable(e.target.value.toLowerCase());
        });
        
        tableContainer.addEventListener('scroll', () => {
            if (tableContainer.scrollTop > 0) {
                tableContainer.classList.add('scrolling');
            } else {
                tableContainer.classList.remove('scrolling');
            }
        });

        downloadBtn.addEventListener('click', downloadAsExcel);

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            dataDisplay.classList.add('hidden');
        }

        async function handleFiles(files) {
            const trcFiles = Array.from(files).filter(file => file.name.toLowerCase().endsWith('.trc'));
            if (trcFiles.length === 0) {
                showError('No .trc files selected. Please upload valid files.');
                return;
            }

            dropZoneContent.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            dataDisplay.classList.add('hidden');

            const parsePromises = trcFiles.map(file => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const parsedData = parseTrcFile(event.target.result);
                            resolve({
                                filename: file.name,
                                ...parsedData
                            });
                        } catch (e) {
                            reject(new Error(`Error parsing ${file.name}: ${e.message}`));
                        }
                    };
                    reader.onerror = () => reject(new Error(`Failed to read ${file.name}.`));
                    reader.readAsText(file);
                });
            });

            try {
                processedFiles = await Promise.all(parsePromises);
                processedFiles.sort((a, b) => a.filename.localeCompare(b.filename)); // Sort by name
                renderFullUI();
            } catch (e) {
                showError(e.message);
            } finally {
                resetDropZone();
            }
        }
        
        function resetDropZone() {
            loadingSpinner.classList.add('hidden');
            dropZoneContent.classList.remove('hidden');
            fileInput.value = ''; // Reset file input
        }

        function renderFullUI() {
            if (processedFiles.length === 0) {
                dataDisplay.classList.add('hidden');
                return;
            }

            renderTabs();
            displayFile(0); // Display the first file by default
            
            dataDisplay.classList.remove('hidden');
            downloadBtn.disabled = false;
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            processedFiles.forEach((file, index) => {
                const tab = document.createElement('button');
                tab.className = 'tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300';
                tab.textContent = file.filename;
                tab.dataset.index = index;
                if (index === activeFileIndex) {
                    tab.classList.add('active');
                }
                tab.addEventListener('click', () => {
                    displayFile(index);
                });
                tabsContainer.appendChild(tab);
            });
        }

        function displayFile(index) {
            activeFileIndex = index;
            const fileData = processedFiles[index];


            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            renderMetadata(fileData.metadata);
            renderTable(fileData);
            searchInput.value = ''; // Clear search on tab change
        }

        function parseTrcFile(content) {
            const lines = content.split('\n').map(line => line.trim());
            
            if (lines.length < 6) throw new Error("File is too short to be a valid TRC file.");

            const metadata = (lines[1].split('\t')).reduce((obj, key, i) => ({ ...obj, [key]: lines[2].split('\t')[i] || '' }), {});

            const markerNamesRaw = lines[3].split('\t');
            const coordNamesRaw = lines[4].split('\t');

            let currentMarker = '';
            const combinedHeaders = coordNamesRaw.map((coord, i) => {
                if (markerNamesRaw[i]) currentMarker = markerNamesRaw[i];
                return i < 2 ? currentMarker : `${currentMarker.trim()} ${coord.trim()}`.trim();
            });

            const topHeaders = [];
            const bottomHeaders = [];
            if (combinedHeaders.length > 0) topHeaders.push({ name: combinedHeaders[0], colspan: 1, rowspan: 2 });
            if (combinedHeaders.length > 1) topHeaders.push({ name: combinedHeaders[1], colspan: 1, rowspan: 2 });

            let currentGroup = null;
            for (let i = 2; i < combinedHeaders.length; i++) {
                const header = combinedHeaders[i];
                if (!header) continue;

                const parts = header.split(' ');
                const marker = parts.slice(0, -1).join(' ');
                const coord = parts.slice(-1)[0];

                if (!currentGroup || currentGroup.name !== marker) {
                    if (currentGroup) topHeaders.push(currentGroup);
                    currentGroup = { name: marker, colspan: 0, rowspan: 1 };
                }
                currentGroup.colspan++;
                bottomHeaders.push(coord);
            }
            if (currentGroup) topHeaders.push(currentGroup);

            const data = [];
            for (let i = 5; i < lines.length; i++) {
                if (!lines[i]) continue;
                const values = lines[i].split('\t');
                const row = {};
                combinedHeaders.forEach((header, index) => {
                    if (header) row[header] = values[index];
                });
                data.push(row);
            }
            
            return { metadata, headers: combinedHeaders, data, topHeaders, bottomHeaders };
        }

        function renderMetadata(metadata) {
            metadataContent.innerHTML = '';
            for (const key in metadata) {
                const item = document.createElement('div');
                item.innerHTML = `<span class="font-semibold text-gray-600">${key}:</span> <span class="text-gray-900 ml-2">${metadata[key]}</span>`;
                metadataContent.appendChild(item);
            }
        }
        
        function renderTable(fileData, dataToRender = null) {
            const data = dataToRender !== null ? dataToRender : fileData.data;
            tableHead.innerHTML = '';
            

            const topHeaderRow = document.createElement('tr');
            topHeaderRow.className = 'top-header-row';
            if (fileData.topHeaders) {
                fileData.topHeaders.forEach(info => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 h-[45px] text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap';
                    th.textContent = info.name;
                    th.colSpan = info.colspan;
                    th.rowSpan = info.rowspan;
                    topHeaderRow.appendChild(th);
                });
            }
            tableHead.appendChild(topHeaderRow);

            if (fileData.bottomHeaders && fileData.bottomHeaders.length > 0) {
                const bottomHeaderRow = document.createElement('tr');
                bottomHeaderRow.className = 'bottom-header-row';
                fileData.bottomHeaders.forEach(text => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap';
                    th.textContent = text;
                    bottomHeaderRow.appendChild(th);
                });
                tableHead.appendChild(bottomHeaderRow);
            }

            tableBody.innerHTML = '';
            if (data.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = fileData.headers.length;
                td.className = 'px-6 py-4 text-center text-gray-500';
                td.textContent = 'No matching data found.';
                tr.appendChild(td);
                tableBody.appendChild(tr);
            } else {
                 data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition-colors';
                    fileData.headers.forEach(header => {
                        const td = document.createElement('td');
                        td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                        td.textContent = row[header] !== undefined ? row[header] : '';
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            }
            
            rowCount.textContent = data.length;
        }
        
        function filterAndRenderTable(searchTerm) {
            const activeFile = processedFiles[activeFileIndex];
            if (!activeFile) return;

            if (!searchTerm) {
                renderTable(activeFile);
                return;
            }

            const filteredData = activeFile.data.filter(row => {
                return Object.values(row).some(value =>
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
            });

            renderTable(activeFile, filteredData);
        }

        function downloadAsExcel() {
            const wb = XLSX.utils.book_new();

            processedFiles.forEach(file => {
                const sheetName = file.filename.replace(/\.trc$/, '').substring(0, 31);
                const headerData = [];
                const topRow = [];
                const merges = [];
                let colIndex = 0;
                file.topHeaders.forEach(h => {
                    topRow[colIndex] = h.name;
                    if (h.colspan > 1) {
                        merges.push({ s: { r: 0, c: colIndex }, e: { r: 0, c: colIndex + h.colspan - 1 } });
                        for(let i=1; i < h.colspan; i++) topRow.push(''); // add empty cells to merge over
                    }
                    if(h.rowspan > 1){
                         merges.push({ s: { r: 0, c: colIndex }, e: { r: 1, c: colIndex } });
                    }
                    colIndex += h.colspan;
                });
                headerData.push(topRow);
                const bottomRow = Array(file.topHeaders.length > 1 ? 2 : 0).fill(''); // empty cells under Frame#/Time
                file.bottomHeaders.forEach(h => bottomRow.push(h));
                headerData.push(bottomRow);
                const dataRows = file.data.map(row => file.headers.map(header => row[header]));
                const ws_data = headerData.concat(dataRows);
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!merges'] = merges;
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            XLSX.writeFile(wb, "trc_export.xlsx");
        }

    </script>

</body>
</html>

